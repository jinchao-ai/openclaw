name: Monitor OpenClaw Release
on:
  # ç›‘å¬ Release å‘å¸ƒäº‹ä»¶
  release:
    types: [published]
  # å¯é€‰ï¼šæ‰‹åŠ¨è§¦å‘æµ‹è¯•
  workflow_dispatch:

jobs:
  send-notification:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'  # ä½¿ç”¨æœ€æ–°ç‰ˆ Python

      - name: Send DingTalk notification via Python
        env:
          # ä» Secrets è¯»å–é’‰é’‰ Webhook åœ°å€
          DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
          # æå–ç‰ˆæœ¬ä¿¡æ¯ä½œä¸ºç¯å¢ƒå˜é‡
          VERSION: ${{ github.event.release.tag_name }}
          TITLE: ${{ github.event.release.name }}
          DESCRIPTION: ${{ github.event.release.body }}
          URL: ${{ github.event.release.html_url }}
        run: |
          # ç¼–å†™ Python è„šæœ¬å¹¶æ‰§è¡Œ
          python - <<EOF
          import requests
          import os
          import json

          # è·å–ç¯å¢ƒå˜é‡ä¸­çš„é…ç½®
          webhook = os.getenv('DINGTALK_WEBHOOK')
          version = os.getenv('VERSION', 'æµ‹è¯•ç‰ˆæœ¬')
          title = os.getenv('TITLE', 'æµ‹è¯•æ ‡é¢˜')
          description = os.getenv('DESCRIPTION', 'æ— æ›´æ–°æè¿°').replace('\\n', '<br>')  # æ¢è¡Œç¬¦æ›¿æ¢ä¸º HTML æ¢è¡Œ
          url = os.getenv('URL', '')

          # é’‰é’‰æ¶ˆæ¯æ¨¡æ¿ï¼ˆmarkdown æ ¼å¼ï¼‰
          msg = {
              "msgtype": "markdown",
              "markdown": {
                  "title": "OpenClaw æ–°ç‰ˆæœ¬å‘å¸ƒ",
                  "text": f"""### ğŸš¨ OpenClaw æ–°ç‰ˆæœ¬å‘å¸ƒ ğŸš¨
- **ç‰ˆæœ¬å·**: {version}
- **æ ‡é¢˜**: {title}
- **æ›´æ–°å†…å®¹**: {description}
- **æŸ¥çœ‹è¯¦æƒ…**: [ç‚¹å‡»è·³è½¬]({url})
                  """
              }
          }

          # å‘é€è¯·æ±‚åˆ°é’‰é’‰æœºå™¨äºº
          try:
              response = requests.post(
                  webhook,
                  data=json.dumps(msg),
                  headers={'Content-Type': 'application/json'}
              )
              response.raise_for_status()  # æŠ›å‡º HTTP é”™è¯¯
              print("é€šçŸ¥å‘é€æˆåŠŸï¼å“åº”ï¼š", response.text)
          except Exception as e:
              print("é€šçŸ¥å‘é€å¤±è´¥ï¼š", str(e))
              raise e  # è®© workflow æ ‡è®°ä¸ºå¤±è´¥
          EOF
