name: Monitor OpenClaw Release
on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  send-notification:
    runs-on: ubuntu-latest
    steps:
      - name: Send DingTalk notification (with signature)
        env:
          # é’‰é’‰æœºå™¨äºº Webhook åœ°å€ï¼ˆæ— ç­¾åå‚æ•°ï¼‰
          WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
          # é’‰é’‰æœºå™¨äººåŠ ç­¾å¯†é’¥ï¼ˆåœ¨åˆ›å»ºæœºå™¨äººæ—¶è·å–ï¼Œéœ€æ–°å¢åˆ° Secretsï¼‰
          SECRET: ${{ secrets.DINGTALK_SECRET }}
          VERSION: ${{ github.event.release.tag_name || 'æµ‹è¯•ç‰ˆæœ¬' }}
          TITLE: ${{ github.event.release.name || 'æµ‹è¯•æ ‡é¢˜' }}
          DESCRIPTION: ${{ github.event.release.body || 'æ— æ›´æ–°æè¿°' }}
          URL: ${{ github.event.release.html_url || '#' }}
        run: |
          # å¤„ç†æ¢è¡Œç¬¦ï¼Œæ›¿æ¢ä¸ºé’‰é’‰æ”¯æŒçš„<br>
          DESCRIPTION=$(echo "$DESCRIPTION" | sed ':a;N;$!ba;s/\n/<br>/g')
          
          # 1. ç”Ÿæˆæ—¶é—´æˆ³å’Œç­¾åï¼ˆè§£å†³310000é”™è¯¯ï¼‰
          timestamp=$(date +%s)
          secret="$SECRET"
          # æ‹¼æ¥å­—ç¬¦ä¸²ï¼štimestamp + "\n" + secret
          string_to_sign="$timestamp\n$secret"
          # ç”¨HMAC-SHA256åŠ å¯†å¹¶base64ç¼–ç 
          sign=$(echo -n "$string_to_sign" | openssl dgst -sha256 -hmac "$secret" -binary | base64)
          # URLç¼–ç ç­¾åï¼ˆå¿…é¡»ï¼‰
          sign_urlencoded=$(echo "$sign" | sed -e 's/+/\%2B/g' -e 's/\//\%2F/g' -e 's/=/\%3D/g')
          
          # 2. æ‹¼æ¥å¸¦ç­¾åçš„å®Œæ•´Webhookåœ°å€
          full_webhook="$WEBHOOKÃ—tamp=$timestamp&sign=$sign_urlencoded"
          
          # 3. æ„é€ é’‰é’‰æ¶ˆæ¯çš„JSONå†…å®¹
          JSON_PAYLOAD=$(cat <<EOF
          {
            "msgtype": "markdown",
            "markdown": {
              "title": "OpenClaw ç‰ˆæœ¬æ›´æ–°",
              "text": "### ğŸš¨ OpenClaw æ–°ç‰ˆæœ¬å‘å¸ƒ ğŸš¨<br>- **ç‰ˆæœ¬å·**: $VERSION<br>- **æ ‡é¢˜**: $TITLE<br>- **æ›´æ–°å†…å®¹**: $DESCRIPTION<br>- **æŸ¥çœ‹è¯¦æƒ…**: [ç‚¹å‡»è·³è½¬]($URL)"
            }
          }
          EOF
          )
          
          # 4. å‘é€POSTè¯·æ±‚åˆ°é’‰é’‰æœºå™¨äººï¼ˆå¸¦ç­¾åï¼‰
          curl -X POST "$full_webhook" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD"
          
          # è¾“å‡ºæ—¥å¿—ï¼Œæ–¹ä¾¿æ’æŸ¥
          echo "æ—¶é—´æˆ³: $timestamp"
          echo "ç­¾å: $sign"
          echo "å®Œæ•´Webhook: $full_webhook"
          echo "å‘é€çš„å†…å®¹: $JSON_PAYLOAD"
