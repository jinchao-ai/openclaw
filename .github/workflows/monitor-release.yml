name: Monitor OpenClaw Release (Original Repo)
on:
  # å®šæ—¶æ£€æŸ¥ï¼šæ¯å°æ—¶ä¸€æ¬¡ï¼ˆå¯æ”¹ï¼Œæ¯”å¦‚ */30 * * * * æ¯30åˆ†é’Ÿï¼‰
  schedule:
    - cron: '*/30 * * * *'
  # ä¿ç•™æ‰‹åŠ¨è§¦å‘ï¼Œæ–¹ä¾¿æµ‹è¯•
  workflow_dispatch:

jobs:
  check-and-notify:
    runs-on: ubuntu-latest
    steps:
      - name: Check latest release of original OpenClaw
        env:
          # æ›¿æ¢ä¸ºåŸ openclaw ä»“åº“çš„åœ°å€ï¼ˆæ¯”å¦‚ owner/openclawï¼‰
          ORIGINAL_REPO: "openclaw/openclaw"
          # å­˜å‚¨ä¸Šæ¬¡è®°å½•çš„ç‰ˆæœ¬å·ï¼ˆç”¨ GitHub Cache æŒä¹…åŒ–ï¼‰
          CACHE_KEY: "openclaw-latest-release"
        run: |
          # 1. è·å–åŸä»“åº“æœ€æ–° Release ä¿¡æ¯
          LATEST_RELEASE=$(curl -s "https://api.github.com/repos/$ORIGINAL_REPO/releases/latest")
          # æå–ç‰ˆæœ¬å·å’Œå…³é”®ä¿¡æ¯
          LATEST_VERSION=$(echo "$LATEST_RELEASE" | jq -r .tag_name)
          LATEST_TITLE=$(echo "$LATEST_RELEASE" | jq -r .name)
          LATEST_DESCRIPTION=$(echo "$LATEST_RELEASE" | jq -r .body | tr '\n' ' ')
          LATEST_URL=$(echo "$LATEST_RELEASE" | jq -r .html_url)
          
          # 2. è·å–ä¸Šæ¬¡è®°å½•çš„ç‰ˆæœ¬å·ï¼ˆé¦–æ¬¡è¿è¡Œä¸ºç©ºï¼‰
          LAST_VERSION=$(cat "$HOME/$CACHE_KEY" 2>/dev/null || echo "")
          
          # 3. å¯¹æ¯”ç‰ˆæœ¬å·ï¼Œæœ‰æ›´æ–°æ‰å‘é€šçŸ¥
          if [ "$LATEST_VERSION" != "$LAST_VERSION" ] && [ "$LATEST_VERSION" != "null" ]; then
            echo "å‘ç°æ–°ç‰ˆæœ¬ï¼š$LATEST_VERSIONï¼ˆæ—§ç‰ˆæœ¬ï¼š$LAST_VERSIONï¼‰"
            
            # 4. å‘é€é’‰é’‰é€šçŸ¥ï¼ˆä¿ç•™ä½ ä¹‹å‰çš„é€»è¾‘ï¼‰
            JSON_PAYLOAD='{
              "msgtype":"text",
              "text":{"content":"ğŸš¨ OpenClaw åŸä»“åº“æ–°ç‰ˆæœ¬å‘å¸ƒ ğŸš¨\nç‰ˆæœ¬å·ï¼š'$LATEST_VERSION'\næ ‡é¢˜ï¼š'$LATEST_TITLE'\næ›´æ–°å†…å®¹ï¼š'$LATEST_DESCRIPTION'\næŸ¥çœ‹è¯¦æƒ…ï¼š'$LATEST_URL'"}
            }'
            
            # æ›¿æ¢ä¸ºä½ çš„é’‰é’‰ Webhookï¼ˆå·²å»æ‰åŠ ç­¾ï¼‰
            curl -X POST "${{ secrets.DINGTALK_WEBHOOK }}" \
              -H "Content-Type: application/json" \
              -d "$JSON_PAYLOAD"
            
            # 5. ä¿å­˜æœ€æ–°ç‰ˆæœ¬å·åˆ°ç¼“å­˜
            echo "$LATEST_VERSION" > "$HOME/$CACHE_KEY"
          else
            echo "æ— æ–°ç‰ˆæœ¬ï¼Œå½“å‰æœ€æ–°ï¼š$LATEST_VERSION"
          fi
          
      - name: Save version cache
        uses: actions/cache@v4
        with:
          path: ~/openclaw-latest-release
          key: ${{ runner.os }}-openclaw-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-openclaw-
