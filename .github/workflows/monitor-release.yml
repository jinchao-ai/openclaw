name: Monitor OpenClaw Release (Original Repo)
on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  check-and-notify:
    runs-on: ubuntu-latest
    permissions:
      # æ˜¾å¼å£°æ˜éœ€è¦çš„æƒé™ï¼ˆå…³é”®ï¼šè§£å†³403ï¼‰
      repository-variables: write  # å†™å…¥ä»“åº“å˜é‡
      contents: read               # è¯»å–ä»“åº“å†…å®¹
    steps:
      # 1. å®‰è£…ä¾èµ–
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # 2. è·å–åŸä»“åº“æœ€æ–°ç‰ˆæœ¬
      - name: Get latest release
        id: get-latest
        run: |
          LATEST_RELEASE=$(curl -s --fail "https://api.github.com/repos/openclaw/openclaw/releases/latest" || echo '{"tag_name":"null"}')
          LATEST_VERSION=$(echo "$LATEST_RELEASE" | jq -r '.tag_name // "null"')
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "æœ€æ–°ç‰ˆæœ¬ï¼š$LATEST_VERSION"

      # 3. è¯»å–å†å²ç‰ˆæœ¬å·ï¼ˆç”¨APIæ›¿ä»£gh cliï¼Œé¿å…æƒé™é—®é¢˜ï¼‰
      - name: Get last notified version
        id: get-last
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          # ç”¨GitHub APIè¯»å–å˜é‡ï¼ˆæ¯”gh cliæ›´ç¨³å®šï¼‰
          RESPONSE=$(curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/repos/$REPO/actions/variables/OPENCLAW_LAST_VERSION")
          # æå–ç‰ˆæœ¬å·ï¼ˆæ— å˜é‡æ—¶è¿”å›ç©ºï¼‰
          LAST_VERSION=$(echo "$RESPONSE" | jq -r '.value // ""')
          echo "last_version=$LAST_VERSION" >> $GITHUB_OUTPUT
          echo "ä¸Šæ¬¡æ¨é€ç‰ˆæœ¬ï¼š$LAST_VERSION"

      # 4. ç‰ˆæœ¬å¯¹æ¯”+å‘é€é€šçŸ¥+æ›´æ–°å˜é‡
      - name: Send notify and update variable
        env:
          DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
          LATEST_VERSION: ${{ steps.get-latest.outputs.latest_version }}
          LAST_VERSION: ${{ steps.get-last.outputs.last_version }}
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          if [ "$LATEST_VERSION" != "null" ] && [ "$LATEST_VERSION" != "$LAST_VERSION" ]; then
            echo "æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬ $LATEST_VERSIONï¼Œæ¨é€é€šçŸ¥..."
            
            # æå–ç‰ˆæœ¬ä¿¡æ¯+å‘é€é’‰é’‰é€šçŸ¥ï¼ˆé€»è¾‘ä¸å˜ï¼‰
            LATEST_RELEASE=$(curl -s "https://api.github.com/repos/openclaw/openclaw/releases/latest")
            LATEST_TITLE=$(echo "$LATEST_RELEASE" | jq -r '.name // "æ— æ ‡é¢˜"')
            LATEST_DESCRIPTION=$(echo "$LATEST_RELEASE" | jq -r '.body // "æ— æ›´æ–°æè¿°"' | tr -d '"\\' | tr '\n' ' ' | cut -c 1-300)
            LATEST_URL=$(echo "$LATEST_RELEASE" | jq -r '.html_url // "https://github.com/openclaw/openclaw"')

            JSON_PAYLOAD=$(jq -n \
              --arg ver "$LATEST_VERSION" \
              --arg title "$LATEST_TITLE" \
              --arg desc "$LATEST_DESCRIPTION" \
              --arg url "$LATEST_URL" \
              '{
                "msgtype":"text",
                "text":{"content":"ğŸš¨ OpenClaw åŸä»“åº“æ–°ç‰ˆæœ¬å‘å¸ƒ ğŸš¨\nç‰ˆæœ¬å·ï¼š\($ver)\næ ‡é¢˜ï¼š\($title)\næ›´æ–°å†…å®¹ï¼š\($desc)\næŸ¥çœ‹è¯¦æƒ…ï¼š\($url)"}
              }')

            curl -X POST "$DINGTALK_WEBHOOK" \
              -H "Content-Type: application/json; charset=utf-8" \
              -d "$JSON_PAYLOAD"

            # ç”¨APIæ›´æ–°å˜é‡ï¼ˆæ›¿ä»£gh cliï¼Œæ›´å…¼å®¹æƒé™ï¼‰
            echo "æ›´æ–°ä»“åº“å˜é‡ä¸ºï¼š$LATEST_VERSION"
            curl -s -X PUT -H "Authorization: token $GH_TOKEN" \
              -H "Content-Type: application/json" \
              "https://api.github.com/repos/$REPO/actions/variables/OPENCLAW_LAST_VERSION" \
              -d '{"name":"OPENCLAW_LAST_VERSION","value":"'$LATEST_VERSION'"}'
          else
            echo "æ— æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ¨é€"
          fi
