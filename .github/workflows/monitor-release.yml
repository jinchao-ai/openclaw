name: Monitor OpenClaw Release (Original Repo)
on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  check-and-notify:
    runs-on: ubuntu-latest
    steps:
      # 1. å®‰è£…ä¾èµ–
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # 2. æ¢å¤ä¸Šæ¬¡ç¼“å­˜çš„ç‰ˆæœ¬å·ï¼ˆæ ¸å¿ƒï¼šå›ºå®šç¼“å­˜key+è·¯å¾„ï¼Œç¡®ä¿æ¯æ¬¡èƒ½è¯»å–åˆ°ï¼‰
      - name: Restore last sent version from cache
        id: cache-version
        uses: actions/cache@v4
        with:
          path: ~/openclaw-last-version.txt  # å›ºå®šè·¯å¾„å­˜å‚¨ç‰ˆæœ¬å·
          key: openclaw-version-cache-${{ runner.os }}  # å›ºå®šç¼“å­˜keyï¼Œä¸éšrun_idå˜åŒ–
          restore-keys: |
            openclaw-version-cache-${{ runner.os }}

      # 3. æ£€æŸ¥ç‰ˆæœ¬+å¯¹æ¯”ç¼“å­˜+å‘é€é€šçŸ¥
      - name: Check release and send notify (avoid duplicate)
        env:
          ORIGINAL_REPO: "openclaw/openclaw"
          DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
        run: |
          # è¯»å–ç¼“å­˜çš„å†å²ç‰ˆæœ¬å·ï¼ˆé¦–æ¬¡è¿è¡Œä¸ºç©ºï¼‰
          LAST_VERSION=$(cat ~/openclaw-last-version.txt 2>/dev/null || echo "")
          echo "ä¸Šæ¬¡æ¨é€çš„ç‰ˆæœ¬å·ï¼š$LAST_VERSION"

          # è·å–åŸä»“åº“æœ€æ–°ç‰ˆæœ¬ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
          LATEST_RELEASE=$(curl -s --fail "https://api.github.com/repos/$ORIGINAL_REPO/releases/latest" || echo '{"tag_name":"null"}')
          LATEST_VERSION=$(echo "$LATEST_RELEASE" | jq -r '.tag_name // "null"')
          echo "åŸä»“åº“æœ€æ–°ç‰ˆæœ¬å·ï¼š$LATEST_VERSION"

          # æ ¸å¿ƒé€»è¾‘ï¼šä»…å½“ç‰ˆæœ¬æ›´æ–°ã€éç©ºã€ä¸”ä¸å†å²ç‰ˆæœ¬ä¸åŒæ—¶æ¨é€
          if [ "$LATEST_VERSION" != "null" ] && [ "$LATEST_VERSION" != "$LAST_VERSION" ]; then
            echo "æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬ $LATEST_VERSIONï¼Œå¼€å§‹æ¨é€é€šçŸ¥..."
            
            # æå–å®Œæ•´ä¿¡æ¯
            LATEST_TITLE=$(echo "$LATEST_RELEASE" | jq -r '.name // "æ— æ ‡é¢˜"')
            LATEST_DESCRIPTION=$(echo "$LATEST_RELEASE" | jq -r '.body // "æ— æ›´æ–°æè¿°"' | tr -d '"\\' | tr '\n' ' ' | cut -c 1-300)
            LATEST_URL=$(echo "$LATEST_RELEASE" | jq -r '.html_url // "https://github.com/openclaw/openclaw"')

            # æ„é€ åˆæ³•JSON
            JSON_PAYLOAD=$(jq -n \
              --arg ver "$LATEST_VERSION" \
              --arg title "$LATEST_TITLE" \
              --arg desc "$LATEST_DESCRIPTION" \
              --arg url "$LATEST_URL" \
              '{
                "msgtype":"text",
                "text":{"content":"ğŸš¨ OpenClaw åŸä»“åº“æ–°ç‰ˆæœ¬å‘å¸ƒ ğŸš¨\nç‰ˆæœ¬å·ï¼š\($ver)\næ ‡é¢˜ï¼š\($title)\næ›´æ–°å†…å®¹ï¼š\($desc)\næŸ¥çœ‹è¯¦æƒ…ï¼š\($url)"}
              }')

            # å‘é€é€šçŸ¥
            curl -X POST "$DINGTALK_WEBHOOK" \
              -H "Content-Type: application/json; charset=utf-8" \
              -d "$JSON_PAYLOAD"

            # ä¿å­˜æ–°ç‰ˆæœ¬å·åˆ°æ–‡ä»¶ï¼ˆè¦†ç›–å†å²ç‰ˆæœ¬ï¼‰
            echo "$LATEST_VERSION" > ~/openclaw-last-version.txt
            echo "é€šçŸ¥æ¨é€æˆåŠŸï¼Œå·²æ›´æ–°ç¼“å­˜ç‰ˆæœ¬å·ä¸ºï¼š$LATEST_VERSION"
          else
            echo "æ— æ–°ç‰ˆæœ¬ï¼ˆå½“å‰ç‰ˆæœ¬ï¼š$LATEST_VERSIONï¼‰ï¼Œæ— éœ€æ¨é€"
          fi

      # 4. å¼ºåˆ¶ä¿å­˜æ–°ç‰ˆæœ¬å·åˆ°ç¼“å­˜ï¼ˆç¡®ä¿ä¸‹æ¬¡èƒ½è¯»å–åˆ°ï¼‰
      - name: Save latest version to cache
        uses: actions/cache/save@v4
        with:
          path: ~/openclaw-last-version.txt
          key: openclaw-version-cache-${{ runner.os }}
