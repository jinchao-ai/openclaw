name: Monitor OpenClaw Release
on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  send-notification:
    runs-on: ubuntu-latest
    steps:
      - name: Send DingTalk notification (simplified format)
        env:
          WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
          SECRET: ${{ secrets.DINGTALK_SECRET }}
          VERSION: ${{ github.event.release.tag_name || 'æµ‹è¯•ç‰ˆæœ¬' }}
          TITLE: ${{ github.event.release.name || 'æµ‹è¯•æ ‡é¢˜' }}
          DESCRIPTION: ${{ github.event.release.body || 'æ— æ›´æ–°æè¿°' }}
          URL: ${{ github.event.release.html_url || '#' }}
        run: |
          # å¤„ç†æ¢è¡Œç¬¦ï¼ˆç®€åŒ–æ›¿æ¢ï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦ï¼‰
          DESCRIPTION=$(echo "$DESCRIPTION" | tr '\n' ' ')
          
          # ç”Ÿæˆç­¾åï¼ˆå¦‚æœå…³é—­åŠ ç­¾ï¼Œå¯åˆ é™¤è¿™éƒ¨åˆ†ï¼‰
          timestamp=$(date +%s)
          string_to_sign="$timestamp\n$SECRET"
          sign=$(echo -n "$string_to_sign" | openssl dgst -sha256 -hmac "$SECRET" -binary | base64)
          sign_urlencoded=$(echo "$sign" | sed -e 's/+/\%2B/g' -e 's/\//\%2F/g' -e 's/=/\%3D/g')
          full_webhook="$WEBHOOKÃ—tamp=$timestamp&sign=$sign_urlencoded"
          
          # æç®€æ¶ˆæ¯æ ¼å¼ï¼ˆé’‰é’‰100%å…¼å®¹ï¼‰
          JSON_PAYLOAD='{
            "msgtype": "text",
            "text": {
              "content": "ğŸš¨ OpenClaw æ–°ç‰ˆæœ¬å‘å¸ƒ ğŸš¨\nç‰ˆæœ¬å·ï¼š'$VERSION'\næ ‡é¢˜ï¼š'$TITLE'\næ›´æ–°å†…å®¹ï¼š'$DESCRIPTION'\næŸ¥çœ‹è¯¦æƒ…ï¼š'$URL'"
            }
          }'
          
          # å‘é€è¯·æ±‚ï¼ˆå¼€å¯è°ƒè¯•æ¨¡å¼ï¼Œæ‰“å°è¯¦ç»†å“åº”ï¼‰
          curl -v -X POST "$full_webhook" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD"
