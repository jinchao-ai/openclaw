name: Monitor OpenClaw Release (Original Repo)
on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  check-and-notify:
    runs-on: ubuntu-latest
    steps:
      # 1. å®‰è£…ä¾èµ–
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # 2. è·å–åŸä»“åº“æœ€æ–°ç‰ˆæœ¬
      - name: Get latest release from original repo
        id: get-latest
        run: |
          # è·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
          LATEST_RELEASE=$(curl -s --fail "https://api.github.com/repos/openclaw/openclaw/releases/latest" || echo '{"tag_name":"null"}')
          LATEST_VERSION=$(echo "$LATEST_RELEASE" | jq -r '.tag_name // "null"')
          # è¾“å‡ºä¸ºstepè¾“å‡ºå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "æœ€æ–°ç‰ˆæœ¬å·ï¼š$LATEST_VERSION"

      # 3. è¯»å–ä¸Šæ¬¡æ¨é€çš„ç‰ˆæœ¬å·ï¼ˆç”¨GitHubå˜é‡æŒä¹…åŒ–ï¼Œæ— å†²çªï¼‰
      - name: Get last notified version
        id: get-last
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          # è¯»å–ä»“åº“çš„ç¯å¢ƒå˜é‡ï¼ˆé¦–æ¬¡è¿è¡Œè¿”å›ç©ºï¼‰
          LAST_VERSION=$(gh variable get OPENCLAW_LAST_VERSION --repo $REPO 2>/dev/null || echo "")
          echo "last_version=$LAST_VERSION" >> $GITHUB_OUTPUT
          echo "ä¸Šæ¬¡æ¨é€ç‰ˆæœ¬å·ï¼š$LAST_VERSION"

      # 4. ç‰ˆæœ¬å¯¹æ¯”+å‘é€é€šçŸ¥
      - name: Compare version and send DingTalk notify
        env:
          DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
          LATEST_VERSION: ${{ steps.get-latest.outputs.latest_version }}
          LAST_VERSION: ${{ steps.get-last.outputs.last_version }}
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          # æ ¸å¿ƒé€»è¾‘ï¼šä»…ç‰ˆæœ¬æ›´æ–°ä¸”éç©ºæ—¶æ¨é€
          if [ "$LATEST_VERSION" != "null" ] && [ "$LATEST_VERSION" != "$LAST_VERSION" ]; then
            echo "æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬ $LATEST_VERSIONï¼Œå¼€å§‹æ¨é€é€šçŸ¥..."
            
            # æå–å®Œæ•´ç‰ˆæœ¬ä¿¡æ¯
            LATEST_RELEASE=$(curl -s "https://api.github.com/repos/openclaw/openclaw/releases/latest")
            LATEST_TITLE=$(echo "$LATEST_RELEASE" | jq -r '.name // "æ— æ ‡é¢˜"')
            LATEST_DESCRIPTION=$(echo "$LATEST_RELEASE" | jq -r '.body // "æ— æ›´æ–°æè¿°"' | tr -d '"\\' | tr '\n' ' ' | cut -c 1-300)
            LATEST_URL=$(echo "$LATEST_RELEASE" | jq -r '.html_url // "https://github.com/openclaw/openclaw"')

            # æ„é€ åˆæ³•JSON
            JSON_PAYLOAD=$(jq -n \
              --arg ver "$LATEST_VERSION" \
              --arg title "$LATEST_TITLE" \
              --arg desc "$LATEST_DESCRIPTION" \
              --arg url "$LATEST_URL" \
              '{
                "msgtype":"text",
                "text":{"content":"ğŸš¨ OpenClaw åŸä»“åº“æ–°ç‰ˆæœ¬å‘å¸ƒ ğŸš¨\nç‰ˆæœ¬å·ï¼š\($ver)\næ ‡é¢˜ï¼š\($title)\næ›´æ–°å†…å®¹ï¼š\($desc)\næŸ¥çœ‹è¯¦æƒ…ï¼š\($url)"}
              }')

            # å‘é€é’‰é’‰é€šçŸ¥
            curl -X POST "$DINGTALK_WEBHOOK" \
              -H "Content-Type: application/json; charset=utf-8" \
              -d "$JSON_PAYLOAD"

            # æŒä¹…åŒ–æ–°ç‰ˆæœ¬å·åˆ°GitHubç¯å¢ƒå˜é‡ï¼ˆæ ¸å¿ƒï¼šæ›¿ä»£ç¼“å­˜ï¼Œæ— å†²çªï¼‰
            echo "æ›´æ–°ä¸Šæ¬¡æ¨é€ç‰ˆæœ¬å·ä¸ºï¼š$LATEST_VERSION"
            gh variable set OPENCLAW_LAST_VERSION --repo $REPO --body "$LATEST_VERSION"
          else
            echo "æ— æ–°ç‰ˆæœ¬ï¼ˆå½“å‰ç‰ˆæœ¬ï¼š$LATEST_VERSIONï¼‰ï¼Œæ— éœ€æ¨é€"
          fi
