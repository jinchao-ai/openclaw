name: Monitor OpenClaw Release (Original Repo)
on:
  # æ¯30åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡åŸä»“åº“ç‰ˆæœ¬
  schedule:
    - cron: '*/30 * * * *'
  # ä¿ç•™æ‰‹åŠ¨è§¦å‘ï¼Œæ–¹ä¾¿æµ‹è¯•
  workflow_dispatch:

jobs:
  check-and-notify:
    runs-on: ubuntu-latest
    steps:
      # å®‰è£…jqå·¥å…·ï¼ˆå¿…é¡»ï¼Œç”¨äºå®‰å…¨æ„é€ JSONï¼‰
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Check latest release of original OpenClaw
        env:
          ORIGINAL_REPO: "openclaw/openclaw"
          DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
        run: |
          # 1. è·å–åŸä»“åº“æœ€æ–° Release ä¿¡æ¯ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
          LATEST_RELEASE=$(curl -s --fail "https://api.github.com/repos/$ORIGINAL_REPO/releases/latest" || echo '{"tag_name":"null","name":"æ— æ ‡é¢˜","body":"æ— æ›´æ–°æè¿°","html_url":"https://github.com/openclaw/openclaw"}')
          
          # 2. æå–å…³é”®ä¿¡æ¯ï¼ˆç”¨jqå®‰å…¨è§£æï¼Œé¿å…æ ¼å¼é”™è¯¯ï¼‰
          LATEST_VERSION=$(echo "$LATEST_RELEASE" | jq -r '.tag_name // "null"')
          LATEST_TITLE=$(echo "$LATEST_RELEASE" | jq -r '.name // "æ— æ ‡é¢˜"')
          # å¤„ç†æ›´æ–°æè¿°ï¼šæ›¿æ¢ç‰¹æ®Šå­—ç¬¦+æˆªæ–­é•¿åº¦ï¼Œé¿å…JSONæŠ¥é”™
          LATEST_DESCRIPTION=$(echo "$LATEST_RELEASE" | jq -r '.body // "æ— æ›´æ–°æè¿°"' | tr -d '"\\' | tr '\n' ' ' | cut -c 1-300)
          LATEST_URL=$(echo "$LATEST_RELEASE" | jq -r '.html_url // "https://github.com/openclaw/openclaw"')
          
          # 3. å¯¹æ¯”ç‰ˆæœ¬å·ï¼Œæœ‰æ›´æ–°æ‰å‘é€šçŸ¥
          if [ "$LATEST_VERSION" != "null" ]; then
            echo "å‘ç°æ–°ç‰ˆæœ¬ï¼š$LATEST_VERSION"
            
            # 4. ç”¨jqæ„é€ åˆæ³•çš„JSONï¼ˆæ ¸å¿ƒä¿®å¤ï¼šé¿å…è¯­æ³•é”™è¯¯ï¼‰
            JSON_PAYLOAD=$(jq -n \
              --arg version "$LATEST_VERSION" \
              --arg title "$LATEST_TITLE" \
              --arg desc "$LATEST_DESCRIPTION" \
              --arg url "$LATEST_URL" \
              '{
                "msgtype": "text",
                "text": {
                  "content": "ğŸš¨ OpenClaw åŸä»“åº“æ–°ç‰ˆæœ¬å‘å¸ƒ ğŸš¨\nç‰ˆæœ¬å·ï¼š\($version)\næ ‡é¢˜ï¼š\($title)\næ›´æ–°å†…å®¹ï¼š\($desc)\næŸ¥çœ‹è¯¦æƒ…ï¼š\($url)"
                }
              }')
            
            # æ‰“å°JSONå†…å®¹ï¼ˆæ–¹ä¾¿è°ƒè¯•ï¼‰
            echo "å‘é€çš„JSONå†…å®¹ï¼š$JSON_PAYLOAD"
            
            # 5. å‘é€é’‰é’‰é€šçŸ¥ï¼ˆç¡®ä¿Content-Typeæ­£ç¡®ï¼‰
            curl -X POST "$DINGTALK_WEBHOOK" \
              -H "Content-Type: application/json; charset=utf-8" \
              -d "$JSON_PAYLOAD"
            
            # ä¿å­˜ç‰ˆæœ¬å·ï¼ˆç®€å•æ–‡ä»¶å­˜å‚¨ï¼Œé¿å…ç¼“å­˜å¤æ‚é—®é¢˜ï¼‰
            echo "$LATEST_VERSION" > ~/openclaw-latest-version.txt
          else
            echo "æ— æ–°ç‰ˆæœ¬ï¼Œå½“å‰æœ€æ–°ï¼š$LATEST_VERSION"
          fi
